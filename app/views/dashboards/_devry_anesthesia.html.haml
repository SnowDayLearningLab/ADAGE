- @users << 61376
= @users
- pulse_scores = []
- asa_scores = []

- avg_time = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ADAGESessionEnd).avg(:duration)
- total_time = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ADAGESessionEnd).sum("duration")
= AdaData.with_game(@game.name).include_filters(@filters).where(key: :ADAGESessionEnd).sum(:duration)

- @users.each do |user_id|
  - end_log = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,user_id: user_id.to_i,name: "PEx Pulse").last

  - if end_log
    - start_log = AdaData.with_game(@game.name).include_filters(@filters).where(client_id: end_log.startContextID).first

    - AdaData.with_game(@game.name).include_filters(@filters).between(_id: start_log._id..end_log._id).where(key: :PlayerEvent_SpinnerOutput,user_id: user_id).each do |record|
      - pulse_scores << record.attempt

  - asa = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,user_id: user_id,name: "ASA-PS Score").last
  - if asa
    - asa_scores << asa.score

  //= AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,user_id: user_id,name: "ASA-PS Score").avg(:score)
  //= AdaData.with_game(@game.name).include_filters(@filters).where(key: :PlayerEvent_SpinnerOutput,user_id: user_id).avg(:attempt)

:javascript

  function Histogram(data){
    var self = this;
    self.convert = function(bin){
      if(!self.init && self.bin !=bin){
        var min_num = Math.min.apply(Math,self.data);
        var max_num = Math.max.apply(Math,self.data);

        var w = (max_num - min_num)/bin;

        self.ticks = [];
        self.values = [];

        for(var i=0; i < bin;i++){
          var min = i*w+min_num;
          var max = (i+1)*w+min_num;
          self.values[i] = 0;
          self.ticks[i] = min;
          self.data.forEach(function(score){
            if(score >= min && score <=max){
              self.values[i] += 1;
            }
          });
        }

        self.init = true;
      }
    };

    self.getValues = function(bin){
      self.convert(bin);

      if(self.values[0] !='x') self.values.unshift('x');
      return self.values;
    };

    self.getLabels = function(bin){
      self.convert(bin);
      if(self.ticks[0] !='') self.ticks.unshift('');
      return self.ticks;
    };

    function Histogram(){
      self.data = data;
      self.init = false;
      self.bin = 0;
      self.ticks = [];
      self.values = [];
    };

    return Histogram();
  };


  $(document).ready( function() {
    var pulse = new Histogram(#{pulse_scores});
    var asa = new Histogram(#{asa_scores});

    c3.generate({
      bindto: "#pulse-check",
      data: {
        type: 'bar',
        x: 'x',
        columns: [
          pulse.getLabels(3),
          pulse.getValues(3),
        ]
      },
      bar: {
        width: {
            ratio: 0.5
        }
      },
      axis: {
        x: {
          label: {
              text: '',
              position: 'outer-center'
          },
          tick: {
            format: function(x){
              return x.toFixed(0);
            }
          }
        },
        y: {
          label: {
              text: 'Number of Students',
              position: 'outer-middle'
          },
          tick: {
            format: function(x){
              return (x == Math.floor(x)) ? x: "";
            }
          }
        }
      },
      legend: {
        show: false
      }
    });

    c3.generate({
      bindto: "#asa-ps",
      data: {
        type: 'bar',
        x: 'x',
        columns: [
          asa.getLabels(3),
          asa.getValues(3),
        ]
      },
      bar: {
        width: {
            ratio: 0.5
        }
      },
      axis: {
        x: {
          label: {
              text: '',
              position: 'outer-center'
          },
          tick: {
            format: function(x){
              return x.toFixed(0);
            }
          }
        },
        y: {
          label: {
              text: 'Number of Students',
              position: 'outer-middle'
          },
          tick: {
            format: function(x){
              return (x == Math.floor(x)) ? x: "";
            }
          }
        }
      },
      legend: {
        show: false
      }
    });
  });

.content.full
  .container
    .one_half.left
      %p 
        = avg_time
      %p 
        = total_time

.content.full
  .container
    %p.header Physical Exam
    .one_half.left
      .center_text Pulse Check (Most Recent Play)
      #pulse-check

    .one_half.right
      .center_text ASA-PS Score (Most Recent Play)
      #asa-ps