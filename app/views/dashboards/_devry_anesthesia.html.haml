- pulse_scores = []
- asa_scores = []

- count = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ADAGESessionEnd).count
- total_time = 0
- AdaData.with_game(@game.name).include_filters(@filters).where(key: :ADAGESessionEnd).pluck(:duration).each do |duration|
  - total_time += duration.to_i
- total_time /= 1000
- avg_time = total_time/count

- avg_pex = []
- AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,name: "PEx Pulse").inject({}) do |record,event|
  - ( record[Time.at(event.timestamp.to_i/1000).strftime("%m/%d/%y")] ||= [] ) << (event.score * 100)
  - record
  - avg_pex = record
- avg_pex.keys.each do |key|
  - avg_pex[key] = avg_pex[key].inject{ |sum, el| sum + el }.to_f / avg_pex[key].size

- avg_asa = []
- AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,name: "ASA-PS Score").inject({}) do |record,event|
  - ( record[Time.at(event.timestamp.to_i/1000).strftime("%m/%d/%y")] ||= [] ) << (event.score * 100)
  - record
  - avg_asa = record
- avg_asa.keys.each do |key|
  - avg_asa[key] = avg_asa[key].inject{ |sum, el| sum + el }.to_f / avg_asa[key].size

- avg_final = []
- AdaData.with_game(@game.name).include_filters(@filters).where(key: :PlayerEvent_FinalScore).inject({}) do |record,event|
  - ( record[Time.at(event.timestamp.to_i/1000).strftime("%m/%d/%y")] ||= [] ) << event.finalScore
  - record
  - avg_final = record
- avg_final.keys.each do |key|
  - avg_final[key] = - avg_final[key].inject{ |sum, el| sum + el }.to_f / - avg_final[key].size

-avg_trimeth = []
-AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,name: "Trimethoprim-Sulfadiazine").inject({}) do |record, event|
  - ( record[Time.at(event.timestamp.to_i/1000).strftime("%m/%d/%y")] ||= [] ) << (event.score * 100)
  - record
  - avg_trimeth = record
- avg_trimeth.keys.each do |key|
  - avg_trimeth[key] = - avg_trimeth[key].inject{ |sum, el| sum + el }.to_f / - avg_trimeth[key].size


- @users.each do |user_id|
  - end_log = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,user_id: user_id.to_i,name: "PEx Pulse").last

  - if end_log
    - start_log = AdaData.with_game(@game.name).include_filters(@filters).where(client_id: end_log.startContextID).first

    - AdaData.with_game(@game.name).include_filters(@filters).between(_id: start_log._id..end_log._id).where(key: :PlayerEvent_SpinnerOutput,user_id: user_id).each do |record|
      - pulse_scores << record.attempt

  - asa = AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,user_id: user_id,name: "ASA-PS Score").last
  - if asa
    - asa_scores << asa.score

- pie = Array.new
- AdaData.with_game(@game.name).include_filters(@filters).only(:name,:duration).where(key: :ContextEnd_GameSection).group_by(&:name).each do |name, event|
  - pie << [ name,event.inject(0){|sum,e| sum += e.duration.to_i }]



- timetho_scores = []
- checklist_scores = Hash.new
- checklist_scores['total'] = 0
- @users.each do |user_id|
  - end_log =  AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_Spinner,user_id: user_id.to_i,name: "Trimethoprim-Sulfadiazine").last
  - if end_log
    - start_log = AdaData.with_game(@game.name).include_filters(@filters).where(client_id: end_log.startContextID).first
    - AdaData.with_game(@game.name).include_filters(@filters).between(_id: start_log._id..end_log._id).where(key: :PlayerEvent_SpinnerOutput,user_id: user_id).each do |record|
      - timetho_scores << record.attempt

  - end_log =  AdaData.with_game(@game.name).include_filters(@filters).where(key: :ContextEnd_GameSection,user_id: user_id.to_i,name: "Perioperative Checklist").last
  - if end_log
    - start_log = AdaData.with_game(@game.name).include_filters(@filters).where(client_id: end_log.startContextID).first

    - AdaData.with_game(@game.name).include_filters(@filters).between(_id: start_log._id..end_log._id).where(key: :PlayerEvent_MultipleChoiceOutput,user_id: user_id).each do |record|
      - if !checklist_scores.has_key? record.attempt
        - checklist_scores[record.attempt] = 0
      - checklist_scores[record.attempt] += 1
      - checklist_scores['total'] += 1

:javascript
  $(document).ready( function() {
    var pulse = new Histogram(#{pulse_scores});
    var asa = new Histogram(#{asa_scores});

    c3.generate({
      bindto: "#pulse-check",
      data: {
        type: 'bar',
        x: 'x',
        columns: [
          pulse.getLabels(6),
          pulse.getValues(6),
        ]
      },
      bar: {
        width: {
            ratio: 0.5
        }
      },
      axis: {
        x: {
          label: {
            text: '',
            position: 'outer-center'
          },
          tick: {
            format: function(x){
              return x.toFixed(0);
            }
          }
        },
        y: {
          label: {
              text: 'Number of Students',
              position: 'outer-middle'
          },
          tick: {
            format: function(x){
              return (x == Math.floor(x)) ? x: "";
            }
          }
        }
      },
      legend: {
        show: false
      }
    });

    c3.generate({
      bindto: "#asa-ps",
      data: {
        type: 'bar',
        x: 'x',
        columns: [
          asa.getLabels(6),
          asa.getValues(6),
        ]
      },
      bar: {
        width: {
            ratio: 0.5
        }
      },
      axis: {
        x: {
          label: {
            text: '',
            position: 'outer-center'
          },
          tick: {
            format: function(x){
              return x.toFixed(1);
            }
          }
        },
        y: {
          label: {
            text: 'Number of Students',
            position: 'outer-middle'
          },
          tick: {
            format: function(x){
              return (x == Math.floor(x)) ? x: "";
            }
          }
        }
      },
      legend: {
        show: false
      }
    });

    c3.generate({
      bindto: "#pie",
      size: {
        width: 130,
        height: 130
      },
      data: {
          columns: #{pie},
          type : 'pie',
      },
      pie: {
        label: {
          format: function (value, ratio, id) {
            return moment(new Date(value/1000)).format('h:mm:ss');
          }
        }
      },
      legend: {
        show: false
      }
    });

    var asa_scores = #{avg_asa.to_json};

    var labels =[];

    var scores = []
    for(var key in asa_scores){
      labels.push(new Date(key).getTime());
      scores.push(asa_scores[key]);
    }
    labels.unshift('x');
    scores.unshift('');
    c3.generate({
      bindto: "#asa-line",
      data: {
        x: 'x',
        x_format : '%Y%m%d',
        columns: [
          labels,
          scores
        ]
      },
      axis: {
        x: {
          type : 'timeseries',
          label: {
            text: 'Date',
            position: 'outer-center'
          }
        },
        y: {
          label: {
            text: 'Avg Score',
            position: 'outer-middle'
          },
          tick: {
            format: function(y){
              return y.toFixed(1);
            }
          }
        }
      },
      legend: {
        show: false
      }
    });

    var final_scores = #{avg_final.to_json};

    var labels =[];

    var scores = []
    for(var key in final_scores){
      labels.push(new Date(key).getTime());
      scores.push(final_scores[key]);
    }
    labels.unshift('x');
    scores.unshift('');
    c3.generate({
      bindto: "#finalScore-line",
      data: {
        x: 'x',
        x_format : '%Y%m%d',
        columns: [
          labels,
          scores
        ]
      },
      axis: {
        x: {
          type : 'timeseries',
          label: {
            text: 'Date',
            position: 'outer-center'
          }
        },
        y: {
          label: {
            text: 'Avg Score',
            position: 'outer-middle'
          },
          tick: {
            format: function(y){
              return y.toFixed(1);
            }
          }
        }
      },
      legend: {
        show: false
      }
    });

    var trimeth_scores = #{avg_trimeth.to_json};

    var labels =[];

    var scores = []
    for(var key in trimeth_scores){
      labels.push(new Date(key).getTime());
      scores.push(trimeth_scores[key]);
    }
    labels.unshift('x');
    scores.unshift('');
    c3.generate({
      bindto: "#trimethScore-line",
      data: {
        x: 'x',
        x_format : '%Y%m%d',
        columns: [
          labels,
          scores
        ]
      },
      axis: {
        x: {
          type : 'timeseries',
          label: {
            text: 'Date',
            position: 'outer-center'
          }
        },
        y: {
          label: {
            text: 'Avg Score',
            position: 'outer-middle'
          },
          tick: {
            format: function(y){
              return y.toFixed(1);
            }
          }
        }
      },
      legend: {
        show: false
      }
    });
    var pex_scores = #{avg_pex.to_json};

    var labels = [];

    var scores = []
    for(var key in pex_scores){
      labels.push(new Date(key).getTime());
      scores.push(pex_scores[key]);
    }

    labels.unshift('x');
    scores.unshift('');

    c3.generate({
      bindto: "#pex-line",
      data: {
        x: 'x',
        x_format : '%Y%m%d',
        columns: [
          labels,
          scores
        ]
      },
      axis: {
        x: {
          type : 'timeseries',
          label: {
            text: 'Date',
            position: 'outer-center'
          },
          tick: {
            fit: true
          }
        },
        y: {
          label: {
              text: 'Avg Score',
              position: 'outer-middle'
          },
          tick: {
            format: function(x){
              return x.toFixed(1);
            }
          }
        }
      },
      legend: {
        show: false
      }
    });


    var timetho = new Histogram(#{timetho_scores});

    c3.generate({
      bindto: "#timetho",
      data: {
        type: 'bar',
        x: 'x',
        columns: [
          timetho.getLabels(5),
          timetho.getValues(5),
        ]
      },
      bar: {
        width: {
            ratio: 0.5
        }
      },
      axis: {
        x: {
          label: {
            text: '',
            position: 'outer-center'
          },
          tick: {
            format: function(x){
              return x.toFixed(0)+"mg";
            }
          }
        },
        y: {
          label: {
              text: 'Number of Students',
              position: 'outer-middle'
          },
          tick: {
            format: function(x){
              return (x == Math.floor(x)) ? x: "";
            }
          }
        }
      },
      legend: {
        show: false
      }
    });
  });

.content.full
  .container
    .two_thirds.left
      %p
        Total time spent playing:
        = Time.at(total_time).utc.strftime("%H:%M:%S")
      %p
        Average time spent playing per session:
        = Time.at(avg_time).utc.strftime("%H:%M:%S")
    .one_third.right
      #pie.right

.content.one_half.right
  .container
    .middle_third
      .title.center_text Flagged Students
      .content
        %ol
          %li
            Student one
          %li
            Student 2
          %li
            Student 333

.content.one_half
  .container
    .full.left.graph
      .title.center_text Final Scores
      #finalScore-line

.content.full
  .container
    %p.header.center_text Physical Exam
    .one_half.left.graph
      .title.center_text Pulse Check (Most Recent Play)
      #pulse-check

    .one_half.right.graph
      .title.center_text Pulse Check Score
      #pex-line
    .content.full_width
      %hr
    .content
      .one_half.left.graph
        .title.center_text ASA-PS Score (Most Recent Play)
        #asa-ps

      .one_half.right.graph
        .title.center_text ASA-PS Scores
        #asa-line


.content.full
  .container
    %p.header.center_text Surgery Prep
    .title.center_text Pre-Op Checklist
    .full_width.middle.graph
      - checklist_scores.keys.each do |key|
        - if key != 'total'
          - percent = checklist_scores[key]*100/checklist_scores['total']
          = render "progress_bar", name: key,percent: percent
    .content.full_width
      %hr
    .one_half.left.graph
      .title.center_text Trimethoprim-Sulfadiazine Dose Entry
      #timetho
    .one_half.right.graph
      .title.center_text Trimethoprim-Sulfadiazine Dose Scores
      #trimethScore-line
